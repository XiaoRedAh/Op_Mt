https://blog.csdn.net/CXikun/article/details/130130901
https://www.cnblogs.com/cyrus0w/p/13123504.html
https://blog.csdn.net/qq_25046827/article/details/125685406


# 为什么要内网穿透

想要搭建一个可供所有用户访问的网站项目，必须在一台具有公网IP地址的云服务器上进行部署，而家中的电脑由于存在于NAT环境中，无法被外部网络主动访问，因此，搭建网站的首选就是购买云服务器。

但是一些情况下，比如业务比较消耗CPU资源，就不得不去加强云服务器的配置，而这笔费用开销往往还不小。或者用OSS搭建个人网盘系统，其中的流量费用是很高的。

实际上，购买云服务器，主要就是图一个公网IP，像是什么计算资源、存储空间，实际上自行购买硬件放在家里反而更加经济实惠（云服务器加个硬盘容量都要很多钱）
关键是家里的环境外网无法访问，就很难受

这时就可以用到内网穿透：让家里的机器主动连接到云服务器，再由云服务器向家里的机器进行**数据包转发**，让家里的设备实现外网访问

内网穿透优点：
* 省钱：计算资源、存储资源可以全部自行部署
* 安全：内网环境下只要限制好端口，黑客很难入侵
* 宽带大：家用宽带一般是10M上行速度起步，办理千兆宽带甚至可以达到100M的上行速度，相比腾讯云的3M小宽带，大了不少。而且，还可以通过增加内网穿透服务器的数量并进行负载均衡来做到吃满上行带宽。

内网穿透缺点：
* 不稳定，停电、断网、电费等
* 网络性能瓶颈，网络速度多快，以及能承受的QPS，全部受限于做内网穿透的云服务器上限

# 内网穿透实现原理

NAT设备自动屏蔽了非内网主机主动发起的连接，也就是说从外网发往内网的数据包将被NAT设备丢弃掉
内网穿透也称为NAT穿透，使具有某一个特定源IP地址和源端口号的数据包不被NAT设备屏蔽而正确路由到内网主机

## 服务器中转数据

**传统实现：服务器中转数据**
>让内网设备事先去绑定一个具有公网IP设备的端口进行通信。那么当其他内网中的设别请求公网设备的指定端口时，我们的内网设备便能知道请求方的IP和端口，随后主动与其通信，实现与内网设备的通信。

在NAT之后的内网服务器可以主动连接公网，但是不能被公网主动访问的，这时可以在中间架设一个公网服务器
* 让在NAT之后的**内网设备持续主动访问这个拥有公网IP地址的服务器**，这样，内网服务器就成功与公网中转服务器建立了一个连接通道。
* 公网中转服务器接收到任何其他NAT后的客户端的主动连接请求后，马上把这个请求通过先前建立好的隧道**转发到内网服务器**，内网服务器将响应发送给公网中转服务器，由它返回给其他NAT后的客户端。

![传统内网穿透.png](https://image.itbaima.net/images/253/image-20231021183032461.png)

## P2P技术

在内网穿透传输大量数据时如果都经过服务器中转的话，会对服务器端带宽产生较大压力，这时可以用P2P技术

**UDP打洞技术(最常见)**
>通过中间服务器的协助，在各自的NAT网关上建立相关的表项，使P2P连接的双方发送的报文能够直接穿透对方的NAT网关，从而实现P2P客户端互连。

如果两台位于NAT设备后面的P2P客户端希望在自己的NAT网关上打个洞，那么他们需要一个协助者——`集中服务器`【本质上是一台被设置在公网上的服务器，建立P2P的双方都可以直接访问它，通过这台集中服务器了解对方的信息并中转各自的信息】，并且还需要一种用于打洞的`Session建立机制`。

Session建立机制：
假定客户端A要发起对客户端B的直接连接，具体的“打洞”过程如下：
（1） A最初不知道如何向客户端B发起连接，于是A向集中服务器发送消息，请求集中服务器帮助建立与客户端B的UDP连接。
（2） 集中服务器将含有B的外网和内网的地址二元组发给A，同时，集中服务器将包含有A的外网和内网的地址二元组信息的消息也发给B。这样一来，A与B就都知道对方外网和内网的地址二元组信息了。
（3） 当A收到由集中服务器发来的包含B的外网和内网的地址二元组信息后，就开始向B的地址二元组**发送UDP数据包**，并且A会**自动锁定第一个给出响应的B的地址二元组**。
同理，当B收到由集中服务器发来的A的外网和内网地址二元组信息后，也会开始向A的外网和内网的地址二元组**发送UDP数据包**，并且**自动锁定第一个得到A回应的地址二元组**。
（4） 一旦A与B都向对方的NAT设备在外网上的地址二元组发送了数据包，就打开了A与B之间的“洞”，A与B向对方的外网地址发送数据，等效于向对方的客户端直接发送UDP数据包。
（5） 一旦应用程序确认已经可以通过往对方的外网地址发送数据包的方式让数据包到达NAT后面的目的应用程序，**程序会停止发送用于“打洞”的数据包，转而开始真正的P2P数据传输**。

UDP转换协议提供的“洞”不是绝对可靠的，多数NAT设备内部都有一个UDP转换的空闲状态计时器，如果在一段时间内没有UDP数据通信，NAT设备会关掉由“打洞”过程打出来的“洞”。如果P2P应用程序希望“洞”的存活时间不受NAT网关的限制，就最好在穿越NAT以后设定一个穿越的有效期。

**TCP打洞技术**
TCP相对于UDP而言要复杂的多，需要更多的开销。但是，由于TCP协议完备的状态机机制，TCP反而比UDP更能精确的获取某个Session的生命期。
一种新的代理类型 XTCP 能解决这个问题，实现方式可以是采用搭建FRP服务器的方式，在传输数据的两端都部署上FRP客户端用于建立直接的连接。
![P2P实现内网穿透.png](https://image.itbaima.net/images/253/image-20231021198365711.png)

## 小结

内网穿透传统方式会出现服务器和客户机之间的数据传输全部经过中转服务器，传输速度将受制于中转服务器的上下行带宽，不过稳定性很好，对于自己要购置的云主机要求就是大带宽，一般这种云主机按流量计费，传输的数据量越大价格自然越贵。

而点对点穿透能解决流量带来的困扰，点对点可以实现服务器和客户机之间打洞直接进行数据通信，这种方式一般用于udp协议的传输，比如应用于远程NAS看视频听歌，但这种方式需要服务器和客户机都安装穿透工具，对用户访问端来说不够方便，而且这种方式受复杂网络环境影响较大，不能100%实现，稳定性欠缺。

# 常用的内网穿透工具

http://blog.itpub.net/69915099/viewspace-2647548


# 使用frp实现内网穿透

frp采用Go语言编写，性能很不错，使用起来也非常稳定
开源地址：https://github.com/fatedier/frp

## 服务端部署frps服务

在GitHub上下载对应的frp程序，解压，然后上传frps到服务器

执行以下命令即可直接运行了
```bash
chmod +x frps
./frps
```

`vim frps.toml`编写配置文件，内容如下：
```toml
bindPort = 7000    #端口
auth.method = "token"   #验证方式
auth.token = "123456"   #token秘钥
```

将其配置为Linux服务的形式运行：
文档：https://gofrp.org/zh-cn/
```bash
sudo vim /etc/systemd/system/frps.service
```

配置文件如下：
```
[Unit]
Description = frp server
After = network.target syslog.target
Wants = network.target

[Service]
Type = simple
ExecStart = /root/frps -c /root/frps.toml

[Install]
WantedBy = multi-user.target
```

打开防火墙端口：包括用于注册的7000端口以及后续给内网其他服务进行穿透的端口（如Nginx的80端口）

启动服务
```bash
systemctl enable frps
systemctl start frps
```

## 客户端部署frpc服务

>客户端也是Ubuntu系统

把下载好的frpc放到内网设备里，发现不能直接执行
```bash
chmod +x frpc
./frpc
```

需要先进行配置

`vim frpc.toml`编写一下配置文件，内容如下：
```
serverAddr = "47.109.97.136"  //之前搭建好的内网穿透服务器地址
serverPort = 7000      //内网穿透服务器注册端口
auth.method = "token"  //使用token验证
auth.token = "123456"  //使用密码

[[proxies]]
name = "nginx"   //配置需要代理的本地服务
type = "tcp"     //类型选择tcp即可（大部分都是）
localIP = "127.0.0.1"   //本地服务的IP地址，因为是直接部署在本地，所以说直接127.0.0.1
localPort = 80    //本地服务端口
remotePort = 80    //远程代理端口
```

配置完成后，就可以启动了
```bash
./frpc -c frpc.toml
```

为了方便，直接注册为服务：
```bash
sudo vim /etc/systemd/system/frpc.service
```

内容如下：
```
[Unit]
Description = frp client
After = network.target syslog.target
Wants = network.target

[Service]
Type = simple
ExecStart = /root/frpc -c /root/frpc.toml

[Install]
WantedBy = multi-user.target
```

然后就可以启动这个服务
```bash
systemctl enable frpc
systemctl start frpc
```

## 开启管理面板

服务端开启管理面板，可以更加有效的监控流量情况：

在服务端配置文件中添加以下内容：
```
webServer.port = 7500   #管理面板端口
webServer.addr = "0.0.0.0"   #绑定到所有网络上，外网访问
webServer.user = "admin"  #管理员名称
webServer.password = "admin"  #管理员密码
```

防火墙中，7500端口要放开